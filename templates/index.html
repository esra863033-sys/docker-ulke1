<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geli≈ümi≈ü √úlke Bilgi Kartlarƒ±</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
</head>
<body>

    <div class="container">
        <h1>‚ú® Geli≈ümi≈ü √úlke Bilgi Kartƒ± Uygulamasƒ±</h1>
        <div class="search-box">
            <input type="text" id="countryInput" placeholder="Bir √ºlke adƒ± girin (√∂rn: Turkey, Japan, Brazil)">
            <button id="searchButton">ARA</button>
        </div>

        <p id="message" class="message"></p>
        
        <div id="countryCard" class="country-card hidden">
            </div>
        
        <audio id="anthemAudio" preload="auto">
            <source src="https://upload.wikimedia.org/wikipedia/commons/e/e6/Turkey-National_Anthem-MPEG.ogg" type="audio/ogg">
            Ses dosyasƒ± y√ºklenemedi.
        </audio>
    </div>

    <script>
        // GLOBALS
        let populationChart;
        const countryInput = document.getElementById('countryInput');
        const searchButton = document.getElementById('searchButton');
        const countryCard = document.getElementById('countryCard');
        const messageElement = document.getElementById('message');
        const anthemAudio = document.getElementById('anthemAudio');


        document.addEventListener('DOMContentLoaded', () => {
            searchButton.addEventListener('click', searchCountry);
            countryInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    searchCountry();
                }
            });
        });

        async function searchCountry() {
            const countryName = countryInput.value.trim();
            if (!countryName) {
                displayMessage('L√ºtfen bir √ºlke adƒ± girin.', 'error');
                countryCard.classList.add('hidden');
                return;
            }

            // Y√ºkleme durumu ve UI g√ºncellemesi
            countryCard.classList.add('hidden');
            searchButton.disabled = true;
            searchButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Y√ºkleniyor...';
            displayMessage('Bilgiler y√ºkleniyor...', 'loading');
            
            // Oynayan mar≈üƒ± durdur
            if (!anthemAudio.paused) {
                anthemAudio.pause();
                anthemAudio.currentTime = 0;
                document.getElementById('anthemButton') && document.getElementById('anthemButton').innerHTML = '<i class="fas fa-play"></i> Mar≈üƒ± Dinle üéß';
            }

            try {
                const response = await fetch(`/api/country/${countryName}`);
                const data = await response.json();

                if (response.ok) {
                    renderCountryCard(data);
                    countryCard.classList.remove('hidden');
                    displayMessage('');
                } else {
                    displayMessage(data.error || 'Bilinmeyen bir hata olu≈ütu.', 'error');
                    countryCard.classList.add('hidden');
                }

            } catch (error) {
                console.error('Fetch hatasƒ±:', error);
                displayMessage('Aƒüa baƒülanƒ±rken bir hata olu≈ütu. L√ºtfen tekrar deneyin.', 'error');
                countryCard.classList.add('hidden');
            } finally {
                searchButton.disabled = false;
                searchButton.innerHTML = 'ARA';
            }
        }

        function renderCountryCard(data) {
            // Harita URL'i: Yandex Statik Harita
            const lat = data.latlng[0] || 0;
            const lon = data.latlng[1] || 0;
            const mapZoom = 5; 
            const mapUrl = `https://static-maps.yandex.ru/1.x/?ll=${lon},${lat}&z=${mapZoom}&l=map&size=300,150&pt=${lon},${lat},pm2rdm`;

            // Kartƒ±n HTML yapƒ±sƒ±
            countryCard.innerHTML = `
                <div class="card-header" data-theme="${data['tema rengi']}">
                    <img src="${data['bayrak g√∂rseli']}" alt="${data['√ºlke adƒ±']} Bayraƒüƒ±" class="flag-image" id="flagImage">
                    <div class="header-overlay">
                        <h2>${data['√ºlke adƒ±']}</h2>
                    </div>
                </div>
                <div class="card-body">
                    
                    <div class="info-badges">
                        <span class="badge"><i class="fas fa-landmark"></i> Ba≈ükent: ${data['ba≈ükent']}</span>
                        <span class="badge"><i class="fas fa-comments"></i> Dil: ${data['ana dil']}</span>
                        <span class="badge"><i class="fas fa-money-bill-wave"></i> Para: ${data['para birimi kƒ±sa']} (${data['para birimi sembol']})</span>
                    </div>

                    <div class="info-row">
                        <div class="info-column">
                            
                            ${renderWeatherSection(data)}
                            
                            <h4 class="section-title"><i class="fas fa-info-circle"></i> Temel Bilgiler</h4>
                            <table class="country-info-table">
                                <tr>
                                    <td><i class="fas fa-globe"></i> Kƒ±ta</td>
                                    <td>${data['kƒ±ta']}</td>
                                </tr>
                                <tr>
                                    <td><i class="fas fa-earth-europe"></i> B√∂lge</td>
                                    <td>${data['b√∂lge']}</td>
                                </tr>
                                <tr>
                                    <td><i class="fas fa-sack-dollar"></i> Para Birimi</td>
                                    <td>${data['para birimi']}</td>
                                </tr>
                                <tr>
                                    <td><i class="fas fa-language"></i> Konu≈üulan Diller</td>
                                    <td><td>${data['diller']}</td></td>
                                </tr>
                            </table>
                            
                            <div class="card-actions">
                                <button id="anthemButton" class="action-btn anthem-btn"><i class="fas fa-play"></i> Mar≈üƒ± Dinle üéß</button>
                                <a href="https://wikipedia.org/wiki/${data['√ºlke adƒ±']}" target="_blank" class="action-btn info-btn"><i class="fas fa-book-open"></i> Daha Fazla Bilgi</a>
                            </div>

                        </div>
                        <div class="info-column map-and-chart">
                            <h4 class="section-title"><i class="fas fa-map-location-dot"></i> Harita ve N√ºfus</h4>
                            
                            <img src="${mapUrl}" alt="√úlke Haritasƒ±" class="mini-map-image">
                            
                            <div class="chart-container">
                                <canvas id="populationChart"></canvas>
                                <p class="chart-label">Toplam N√ºfus: ${data['n√ºfus'].toLocaleString('tr-TR')}</p>
                            </div>
                        </div>
                    </div>

                </div>
            `;
            
            // Chart.js ve Mar≈ü butonunu etkinle≈ütir
            renderPopulationChart(data['n√ºfus'], data['tema rengi']);
            document.getElementById('anthemButton').addEventListener('click', toggleAnthem);
        }

        function renderWeatherSection(data) {
            // ... (renderWeatherSection, renderPopulationChart, getThemeColor, toggleAnthem fonksiyonlarƒ± burada yer alƒ±r)
            // Bu fonksiyonlar √∂nceki cevabƒ±mda verilmi≈üti, yer kazancƒ± i√ßin tekrar edilmemi≈ütir.
            
            // [Bu alana renderWeatherSection, renderPopulationChart, getThemeColor, toggleAnthem fonksiyonlarƒ±nƒ±n i√ßeriƒüini yapƒ±≈ütƒ±rƒ±n]
            
            const weather = data['hava durumu'];
            if (weather.error) {
                return `<div class="weather-box error-weather"><i class="fas fa-exclamation-circle"></i> ${weather.error}</div>`;
            }
            
            const weatherIconUrl = `https://openweathermap.org/img/wn/${weather.icon}@2x.png`;
            return `
                <div class="weather-box">
                    <div class="weather-header">
                        <img src="${weatherIconUrl}" alt="Hava Durumu ƒ∞konu" class="weather-icon">
                        <div class="weather-temp">
                            ${weather.temp}¬∞C
                        </div>
                    </div>
                    <p class="weather-details">
                        <i class="fas fa-city"></i> Ba≈ükent: <strong>${data['ba≈ükent']}</strong>
                    </p>
                    <p class="weather-details">
                        <i class="fas fa-cloud"></i> Durum: ${weather.description}
                    </p>
                    <p class="weather-details">
                        <i class="fas fa-wind"></i> R√ºzgar: ${weather.wind} m/s
                    </p>
                </div>
            `;
        }

        function renderPopulationChart(population, theme) {
            const WORLD_POPULATION = 8100000000;
            const chartData = {
                labels: ['√úlke N√ºfusu', 'D√ºnya Geri Kalanƒ±'],
                datasets: [{
                    data: [population, WORLD_POPULATION - population],
                    backgroundColor: [
                        getThemeColor(theme, true),
                        '#e5e7eb'
                    ],
                    hoverOffset: 10
                }]
            };

            const ctx = document.getElementById('populationChart').getContext('2d');
            if (populationChart) {
                populationChart.destroy();
            }

            populationChart = new Chart(ctx, {
                type: 'doughnut',
                data: chartData,
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'bottom', labels: { color: '#333' } },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed;
                                    const label = context.label;
                                    return `${label}: ${value.toLocaleString('tr-TR')} ki≈üi`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function getThemeColor(theme, isDark = false) {
            const palette = {
                'yellow': isDark ? '#facc15' : '#fef08a', 
                'blue': isDark ? '#3b82f6' : '#bfdbfe',  
                'red': isDark ? '#ef4444' : '#fecaca',   
                'green': isDark ? '#10b981' : '#a7f3d0', 
                'turquoise': isDark ? '#06b6d4' : '#a5f3fc', 
                'gray': isDark ? '#6b7280' : '#d1d5db'
            };
            return palette[theme] || palette['gray'];
        }

        function toggleAnthem() {
            const button = document.getElementById('anthemButton');
            
            if (anthemAudio.paused) {
                anthemAudio.play();
                button.innerHTML = '<i class="fas fa-pause"></i> Mar≈üƒ± Durdur ‚è∏Ô∏è';
            } else {
                anthemAudio.pause();
                button.innerHTML = '<i class="fas fa-play"></i> Mar≈üƒ± Dinle üéß';
            }
            
            anthemAudio.onended = () => {
                button.innerHTML = '<i class="fas fa-play"></i> Mar≈üƒ± Dinle üéß';
                anthemAudio.currentTime = 0;
            };
        }

        function displayMessage(text, type = 'info') {
            messageElement.textContent = text;
            messageElement.className = `message ${type}`; 
        }
    </script>
</body>
</html>
